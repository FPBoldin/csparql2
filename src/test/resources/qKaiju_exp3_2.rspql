PREFIX tr: <http://polimi.deib/tracing#>

REGISTER RSTREAM <s1> AS
SELECT (?tid AS ?traceId) (?sn2 AS ?serviceFrom) (?sn AS ?serviceTo) (COUNT(*) AS ?n_interactions)
FROM NAMED WINDOW <win> ON <jsonTraces> [RANGE PT10S STEP PT10S]
WHERE  {
    WINDOW ?w {
    	?t a tr:Trace ;
    		tr:traceId ?tid .
        ?s a tr:Span ;
            tr:spanOfTrace ?t ;
        	tr:spanId ?sid ;
        	tr:spanOfProcess ?p .
        ?p tr:serviceName ?sn .
        ?s2 a tr:Span ;
            tr:spanOfTrace ?t ;
        	tr:spanId ?sid2 ;
        	tr:spanOfProcess ?p2 .
        ?p2 tr:serviceName ?sn2 .
        ?s tr:reference ?s2 .
    }
}
GROUP BY ?tid ?sn ?sn2
ORDER BY ?tid